<% if @recurring_appointment.errors.any?  %>
  $('#nurse-conflict-days').text("<%= j @recurring_appointment.errors[:base].join('、') + 'のヘルパーが重複してます。' %>")
  $('.modal').modal('hide');
  $('#nurse-conflict-confirm').dialog({
    resizable: false,
    height: 'auto',
    width: 400,
    modal: true,
    buttons: {
      '登録する':function(){
        $(this).dialog('close');
        console.log("<%=  @recurring_appointment.errors[:nurse_id].flatten %>");
        let appointment_ids = <%=  @recurring_appointment.errors[:nurse_id].flatten %>;
        console.log(appointment_ids)
        let indexCount =  0;
        appointment_ids.forEach(function(appointment_id, index, array){
          let request_edit_url = '/plannings/' + <%= @recurring_appointment.planning_id %> + '/appointments/' + appointment_id + '/toggle_edit_requested';
          console.log(request_edit_url)
          indexCount++;
          console.log(indexCount)

          $.ajax({
            url: request_edit_url,
            type: 'PATCH',
            beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
            success: function(data) {
              if (indexCount == appointment_ids.length) {
                console.log('made it in the loop')
                $('input#save-recurring-appointment').click()
              }
            }
          })
        })
      },
      'キャンセル':function(){
        let edit_url = "<%= j edit_planning_recurring_appointment_path(@recurring_appointment.planning, @recurring_appointment) %>";
        $.getScript(edit_url, function(){
          masterSwitchToggle();
          toggleEditRequested();
          recurringAppointmentFormChosen();
        });
        $(this).dialog('close');
      }
    }
  })
<% else %>
  $('.modal').modal('hide');

  if (typeof calendar === 'undefined') {
    let calendar;
  }
  if ($('.calendar').length > 0) {
    calendar = $('.calendar');
  } else if ($('.patient_calendar').length > 0) {
    calendar = $('.patient_calendar');
  } else if ($('.nurse_calendar').length > 0) {
    calendar = $('.nurse_calendar');
  } else if ($('.master_calendar').length > 0) {
    calendar = $('.master_calendar');
  }

  console.log(calendar)

  <% @appointments.each do |appointment| %>
    calendar.fullCalendar('removeEvents', '<%= "appointment_#{appointment.id}" %>' );

    calendar.fullCalendar(
      'renderEvent', 
      $.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: appointment}).html_safe  %>"), 
      false
    );
  <% end %>

  if ($('#planning-activities').length > 0) {
    $('#planning-activities').prepend("<%= j render partial: 'activities/activity', locals: {activity: @activity} %>")
  }

<% end %>

