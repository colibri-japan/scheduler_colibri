<div id='dashboard-plannings-container'>
  <div id='new-planning-container'>
    <%= link_to '+新規スケジュール', new_planning_path, class: 'btn btn-info btn-sm text-white btn-margin-top' %>
  </div>
  <div id='dashboard-plannings-list'>
    <% @plannings.each do |planning| %>
      <div class="resource-list-element" data-url="<%= planning_path(planning) %>"><%= planning.title %></div>
    <% end %>
  </div>
</div>

<div id='colibri-dashboard-container'>
  <div id='colibri-dashboard-commands'>
    <%= link_to '日報をダウンロード', dashboard_index_path(format: :xlsx), class: 'btn btn-success btn-sm text-white' %>
  </div>
  <div class='colibri-dashboard-container-row'>
    <% if current_user.admin %>
      <div class='colibri-dashboard-subcontainer'>
        <div class='colibri-subcontainer-header'>
          <span class='colibri-subcontainer-title'>給与推移</span>
        </div>
        <div class='colibri-subcontainer-body'>
          <%= area_chart @provided_service_data, height: '95%', width: '500px', colors: ['#17a2b8'], suffix: '￥' %>
        </div>
      </div>
    <% else %>
      <div class='colibri-dashboard-subcontainer'>
        <div class='colibri-subcontainer-header'>
          <span class='colibri-subcontainer-title'>稼働時間推移</span>
        </div>
        <div class='colibri-subcontainer-body'>
          <%= area_chart @provided_service_duration_sums, height: '95%', width: '500px', colors: ['#17a2b8'] %>
        </div>
      </div>
    <% end %>

    <div class='colibri-dashboard-subcontainer'>
      <div class='colibri-subcontainer-header'>
        <span class='colibri-subcontainer-title'>最新履歴</span><span class="unseen-activity-count"><%= "   ログアウト以降：#{@unseen_activity_count}" %></span>
      </div>
      <div class='colibri-subcontainer-body'>
      	<% @activities.each do |activity| %>
					<%= render partial: 'activities/activity', locals: {activity: activity} %>
				<% end %>
      </div>
    </div>

  </div>

  <% if current_user.admin %>

  <div class='colibri-dashboard-container-row'>

    <div class='colibri-dashboard-subcontainer'>
      <div class='colibri-subcontainer-header'>
        <span class='colibri-subcontainer-title'>利用状況(本日)</span>
      </div>
        <div class='colibri-subcontainer-body'>
          <table class='table'>
            <thead>
              <tr>
                <th class="table-important-fields">サービス</th>
                <th class="table-important-fields">女</th>
                <th class="table-important-fields">男</th>
                <th class="table-important-fields">計</th>
              </tr>
            </thead>
            <tbody>
              <%  @appointments_grouped_by_title.each do |service_name, appointments| %>
                <tr>
                  <th><%= service_name %></th>
                  <th><%= appointments.select{|appointment| @female_patients_ids.include?(appointment.patient_id)}.count %></th>
                  <th><%= appointments.select{|appointment| @male_patients_ids.include?(appointment.patient_id)}.count %></th>
                  <th><%= appointments.count %></th>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
    </div>

    <div class='colibri-dashboard-subcontainer'>
      <div class='colibri-subcontainer-header'>
        <span class='colibri-subcontainer-title'>利用状況(今月)</span>
      </div>
        <div class='colibri-subcontainer-body'>
          <table class='table'>
            <thead>
              <tr>
                <th class="table-important-fields">サービス</th>
                <th class="table-important-fields">女</th>
                <th class="table-important-fields">男</th>
                <th class="table-important-fields">計</th>
              </tr>
            </thead>
            <tbody>
              <%  @monthly_appointments_grouped_by_title.each do |service_name, appointments| %>
                <tr>
                  <th><%= service_name %></th>
                  <th><%= appointments.select{|appointment| @female_patients_ids.include?(appointment.patient_id)}.count %></th>
                  <th><%= appointments.select{|appointment| @male_patients_ids.include?(appointment.patient_id)}.count %></th>
                  <th><%= appointments.count %></th>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
    </div>

  </div>

  <% end %>

  <div class='colibri-dashboard-container-row'>

    <div class='colibri-dashboard-subcontainer'>
      <div class='colibri-subcontainer-header'>
        <span class='colibri-subcontainer-title'>本日のサービス</span>
      </div>
        <div class='colibri-subcontainer-body'>
          <table class='table'>
            <thead>
              <tr>
                <th class="table-important-fields">利用者名</th>
                <th class="table-important-fields">性別</th>
                <th class="table-important-fields">訪問時間</th>
                <th class="table-important-fields">ヘルパー</th>
                <th class="table-important-fields">サービスタイプ</th>
              </tr>
            </thead>
            <tbody>
              <% @appointments.each do |nurse_id, appointments_array| %>
                <% appointments_array.each do |appointment| %>
                  <tr>
                    <th><%= appointment.patient.try(:name) %></th>
                    <th><%= patient_gender(appointment.patient) %></th>
                    <th><%= "#{appointment.starts_at.strftime('%H:%M')} ~ #{appointment.ends_at.strftime('%H:%M')}" %></th>
                    <th><%= appointment.nurse.try(:name) %></th>
                    <th><%= appointment.title %></th>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
    </div>
  </div>
</div>
