$('.modal').modal('hide')

<% if @appointment.errors.any? %>
  $('.modal').modal('hide');
  $('.modal-backdrop').remove();

  $('#nurse-overlapping-days').text("<%= j @appointment.errors[:base].first %>");
  $('#nurse-overlap-modal').modal({ backdrop: 'static' })

  $('#nurse-overlap-override').one('click', function(){
    let appointment_ids = <%=  @appointment.errors[:nurse_id].flatten %>;
    let indexCount =  0;
    appointment_ids.forEach(function(appointment_id, index, array){
      let request_edit_url = '/plannings/' + <%= @appointment.planning_id %> + '/appointments/' + appointment_id + '/toggle_edit_requested';
      indexCount++;
      $.ajax({
        url: request_edit_url,
        type: 'PATCH',
        beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
        success: function(data) {
          if (indexCount == appointment_ids.length) {
            $('input#save-appointment').click();
          }
        }
      })
    })
  })

<% else %>
  if (typeof fullcalendar === 'undefined') {
    let fullcalendar;
  }
  if ($('.calendar').length > 0) {
    fullcalendar = $('.calendar');
  } else if ($('.patient_calendar').length > 0) {
    fullcalendar = $('.patient_calendar');
  } else if ($('.nurse_calendar').length > 0) {
    fullcalendar = $('.nurse_calendar');
  } else {
    fullcalendar = ''
  }

  if (fullcalendar && window.nurseId == <%= @appointment.nurse_id %>  || window.patientId == <%= @appointment.patient_id %> || window.generalPlanning == 'true' ) {
    fullcalendar.fullCalendar(
      'renderEvent',
      $.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe %>")
    )
  }

  if (typeof renderEvent === 'undefined') {
    let renderEvent
  }
  
  renderEvent = (window.currentResourceType === 'team') || (window.currentResourceType === 'nurse' && ['all', '<%= @appointment.nurse_id %>'].includes(window.currentResourceId)) || (window.currentResourceType === 'patient' && ['all', '<%= @appointment.patient_id %>'].includes(window.currentResourceId) )

  if (window.fullCalendar && renderEvent) {
    window.fullCalendar.addEvent($.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe %>"))
  }

<% end %>