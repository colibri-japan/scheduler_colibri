<% if @recurring_appointment.errors.any? %>
  <% if @recurring_appointment.master == true %>
    console.log('master true')
    alert("<%= j @recurring_appointment.errors[:base].join('、') + 'の従業員が重複してます。' %>")
  <% else %>
    $('#nurse-conflict-days').text("<%= j @recurring_appointment.errors[:base].join('、') + 'の従業員が重複してます。' %>")
    $('.modal').modal('hide');
    $('#nurse-conflict-confirm').dialog({
      resizable: false,
      height: 'auto',
      width: 400,
      modal: true,
      buttons: {
        '登録する':function(){
          $(this).dialog('close');
          let appointment_ids = <%=  @recurring_appointment.errors[:nurse_id].flatten %>;
          let indexCount =  0;

          appointment_ids.forEach(function(appointment_id, index, array){
            let request_edit_url = '/plannings/' + <%= @recurring_appointment.planning_id %> + '/appointments/' + appointment_id + '/toggle_edit_requested';
            $.ajax({
              url: request_edit_url,
              type: 'PATCH',
              success: function() {
                indexCount++
                if (indexCount == appointment_ids.length) {
                  console.log('now sending the form again')
                  $('input#save-recurring-appointment').click();
                } else {
                  console.log(indexCount)
                }
              }
            });
          });
        },
        'キャンセル':function(){
          $(this).dialog('close');
        }
      }
    })
  <% end %>

<% else %>
  $('.modal').modal('hide');
  if (typeof calendar === 'undefined') {
    let calendar;
  }
  if ($('.calendar').length > 0) {
    calendar = $('.calendar');
  } else if ($('.patient_calendar').length > 0) {
    calendar = $('.patient_calendar');
  } else if ($('.nurse_calendar').length > 0) {
    calendar = $('.nurse_calendar');
  } else if ($('.master_calendar').length > 0) {
    calendar = $('.master_calendar');
  }
  <% if @recurring_appointment.master == true %>
    if (window.nurseId == <%= @recurring_appointment.nurse_id %> || window.patientId == <%= @recurring_appointment.patient_id %>) {
      calendar.fullCalendar(
        'renderEvents',
        jQuery.parseJSON("<%= j render(partial: 'recurring_appointments/recurring_appointment.json', locals: {recurring_appointment: @recurring_appointment}).html_safe %>")
      );
    }
  <% else %>
    <% @appointments.each do |appointment| %>
      if (window.nurseId == <%= appointment.nurse_id %> || window.patientId == <%= appointment.patient_id %> || window.generalPlanning == 'true' ) {
        calendar.fullCalendar(
          'renderEvent', 
          jQuery.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: appointment}).html_safe %>"),
          false
        );
      }
    <% end %>
  <% end %>
<% end %>
