<%= javascript_tag do  %>
	window.nursePayableUrl = "<%= j planning_nurse_payable_path(@planning, @nurse) %>";
	window.excelUrl = "<%= j planning_nurse_payable_path(@planning, @nurse, format: :xlsx) %>"
<% end %>

<%= render 'plannings/planning_payable_submenu' %>

<div id="resource-list-container" class="no-print">
  <div id="resource-container" class="scrollbar-custom colibri-scrollbar-dark">
	<div id="nurses-resource" class="no-print">
			<div class="nurses-resource-subsection-title resource-title-selectable colibri-clickable-link" data-url="<%= planning_payable_path(@planning) %>">全員</div>
			<% @grouped_nurses.each do |group, nurses| %>
				<div class="nurses-resource-subsection-title <%= 'resource-title-selectable colibri-clickable-link' if @team_name_by_id.present? %>" data-url="/plannings/<%= @planning.id %>/teams/<%= @team_name_by_id.key(group) %>"><%= group %></div>
				<% nurses.each do |nurse| %>
					<p class="resource-list-element colibri-clickable-link  <%= 'resource-selected' if nurse == @nurse %>" data-url="<%= planning_nurse_payable_path(@planning, nurse) %>"><%= nurse.try(:name) %></p>
				<% end %>
			<% end %>
	</div>
  </div>
</div>

<div id="payable-container">
	<div id="detail-planning-title">
		<p class="planning-activity-module-title" id="payable-title"><%= "#{@nurse.name}の給与 #{@planning.business_month}月" %></p>
	</div>


	<div id="payable-charts">
		<%# pie_chart [["現在の合計給料", @chart_wage_data[true]], ["将来の合計給料", @chart_wage_data[false]]], donut: true, colors: ['#ffc107', '#dc3545'], suffix: '¥', thousands: ',', width: '200px', height: '200px' %>
		<% if  @total_time_pending > 0 %>
			<div id="hours-worked-pied-container">
				<%= pie_chart [['稼働時間', @total_time_worked], ['稼働予定時間', @total_time_pending]], donut: true,  width: '130px', height: '130px', legend: false, colors: ['#ffc107', '#e4e4e4'], library: {tooltips: {enabled: false}} %>
			</div>
		<% end %>
		<div id="payable-dashboard">
			<div class="payable-dashboard-text-container">
				<p class="payable-dashboard-line">稼働時間: <span class="payable-dashboard-important"><%= from_seconds_to_hours_minutes(@total_time_worked) %></span></p>
				<p class="payable-dashboard-line">稼働予定時間: <span class="payable-dashboard-important"><%= from_seconds_to_hours_minutes(@total_time_pending) %></span></p>
			</div>
		</div>
	</div>

	<div id='payable-table-commands'>
	    <div id="add-provided-service-line">
			<%= link_to '+手当を追加する', new_nurse_provided_service_path(@nurse, params: {planning_id: @planning.id}), class: 'btn btn-info text-white', remote: true %>
			<%= link_to "#{@nurse.try(:name)}の給与テーブル", nurse_services_path(@nurse, params: {planning_id: @planning.id}), class: 'btn btn-info text-white', remote: true if current_user.corporation_admin? %>
		</div>
		<% if current_user.corporation_admin? %>
			<div class="excel-download btn btn-success text-white" id="payable-download-button"><span class="glyphicon glyphicon-download" style="color:white"></span> ダウンロードする</div>
		<% end %>
	</div>

	<table class="table">
		<thead>
			<tr>
				<th class="table-important-fields">日付</th>
				<th class="table-important-fields">タイプ</th>
				<th class="table-important-fields">利用者名</th>
				<th class="table-important-fields">提供時間</th>
				<th class="table-important-fields">開始~終了</th>
				<% if current_user.corporation_admin? %>
					<th class="table-important-fields">時給/単価</th>
				<% end %>
				<% if current_user.corporation_admin? %>
					<th class="table-important-fields">計</th>
				<% end %>
				<th class="table-important-fields"></th>
				<th class="table-important-fields"></th>
			</tr>
			
		</thead>

		<tbody>
			<% @services_till_now.each do |provided_service| %>
			<tr class="<%= 'weekend-holiday-provided-service' if provided_service.weekend_holiday_provided_service? %> ">
				<td><%= provided_service.service_date.strftime("%-m月%-d日") + ' ' + weekday(provided_service.service_date) %></td>
				<td><%= provided_service_title_with_counts(provided_service) %></td>
				<td><%= provided_service.patient.try(:name) %> </td>
				<td><%= from_seconds_to_hours_minutes(provided_service.service_duration) if provided_service.service_duration.present? %></td>
				<td><%= "#{provided_service.appointment_start.strftime('%H:%M')}~#{provided_service.appointment_end.strftime('%H:%M')}"  if provided_service.appointment_start.present? && provided_service.appointment_end.present? %></td>
				<% if current_user.corporation_admin? %>
					<td><%= "#{provided_service.unit_cost}¥" %></td>
				<% end %>
				<% if current_user.corporation_admin? %>
					<td id="service-total-<%= provided_service.id %>"><%= "#{provided_service.total_wage}¥" %></td>
				<% end %>
                <td class='verify-provided-service ' id='provided-service-<%= provided_service.id %>'>
				  <div class='<%= 'cancelled-provided-service' if provided_service.cancelled == true %> <%= 'edit-requested-provided-service' if provided_service.appointment.present? && provided_service.appointment.edit_requested == true %>'>
					<% if provided_service.cancelled == true %>
						<span>キャンセル</span>
					<% elsif provided_service.appointment.present? && provided_service.appointment.edit_requested == true %>
						<span>調整中リスト</span>
					<% else %>
						<% if provided_service.verified? %>
							<div><span class='glyphicon glyphicon-ok'  style="color: #42B97C"></span></div>
						<% else %>
							<%= link_to '確認', verify_provided_service_path(provided_service), method: :patch, remote: :true, class: 'btn btn-success btn-sm' if !provided_service.verified? %>
						<% end %>
					<% end %>
				  </div>
                </td>
				<td>
					<% if provided_service.appointment.present? %>
						<%= link_to '編集', edit_planning_appointment_path(@planning, provided_service.appointment), remote: true, class: 'btn btn-sm btn-success text-white' %>
					<% else %>
						<%= link_to '編集', edit_nurse_provided_service_path(@nurse, provided_service, params: {planning_id: @planning.id}), remote: true, class: 'btn btn-sm btn-success text-white' %>
					<% end %>
				</td>

			</tr>
			<% end %>
			<% if @counter.present? && current_user.corporation_admin? %>
				<tr>
					<td></td>
					<td>移動手当 (x<%= @counter.service_counts %>)</td>
					<td></td>
					<td></td>
					<td></td>
					<td>
						<%= @counter.unit_cost %>
					</td>
					<td id="service-total-<%= @counter.id %>"><%= @counter.total_wage %>¥</td>
					<td class='verify-provided-service' id='provided-service-<%= @counter.id %>'>
						<% if @counter.verified? %>
							<div><span class='glyphicon glyphicon-ok'  style="color: #42B97C"></span></div>
						<% else %>
							<%= link_to '確認', verify_provided_service_path(@counter), method: :patch, remote: :true, class: 'btn btn-success btn-sm'  %>
						<% end %>
					</td>
					<td><%= link_to '編集', edit_nurse_provided_service_path(@nurse, @counter, params: {planning_id: @planning.id}), remote: true, class: 'btn btn-sm btn-success text-white' %></td>
				</tr>
			<% end %>
			<% if current_user.corporation_admin? %>
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td id="total-salary-label">合計：</td>
					<td id="total-salary"><%= @total_till_now %>¥</td>
					<td></td>
					<td></td>
				</tr>
			<% end %>
		</tbody>
		
	</table>


	<table class="table">
		<thead>
			<tr>
				<th class="table-important-fields">タイプ</th>
				<th class="table-important-fields">提供時間</th>
				<th class="table-important-fields">回数</th>
				<% if current_user.corporation_admin? %>
					<th class="table-important-fields">時給/単価</th>
					<th class="table-important-fields">計</th>
				<% end %>
			</tr>
		</thead>
		<tbody class="text-not-bold">
			<% @grouped_services.each do |service| %>
				<tr>
					<td><%= service.title %></td>
					<td><%= from_seconds_to_hours_minutes(service.service_duration) if service.service_duration > 0 %></td>
					<td><%= service.service_counts %></td>
					<% if current_user.corporation_admin? %>
						<td><%= service.unit_cost %></td>
						<td><%= service.total_wage %></td>
					<% end %>
				</tr>
			<% end %>
			<% if @counter.present? && current_user.corporation_admin? %>
				<tr>
					<td>移動手当</td>
					<td></td>
					<td>
						<%= @counter.unit_cost %>
					</td>
					<td>
						<%= @counter.service_counts %>
					</td>
					<td class="service-total-<%= @counter.id %>"><%= @counter.total_wage %>¥</td>
				</tr>
			<% end %>
			<% if current_user.corporation_admin? %>
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td id="total-salary-label">合計：</td>
					<td id="total-salary"><%= @total_till_now %>¥</td>
				</tr>
			<% end %>
		</tbody>
	</table>
	
</div>