<% if @appointment.errors.any? %>
  $('.modal').modal('hide');
  $('.modal-backdrop').remove();
  
  $('#nurse-overlapping-days').text("<%= j @appointment.errors[:base].first %>");

  $('#nurse-overlap-modal').modal({ backdrop: 'static' })

  $('#nurse-overlap-override').one('click', function(){
    let appointment_ids = <%=  @appointment.errors[:nurse_id].flatten %>;
    let indexCount =  0;
    appointment_ids.forEach(function(appointment_id, index, array){
      let request_edit_url = '/plannings/' + <%= @appointment.planning_id %> + '/appointments/' + appointment_id + '/toggle_edit_requested';
      indexCount++;
      $.ajax({
        url: request_edit_url,
        type: 'PATCH',
        beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
        success: function(data) {
          if (indexCount == appointment_ids.length) {
            let appointment_data;
            appointment_data = {
              appointment: {
                starts_at: "<%= @appointment.starts_at %>",
                ends_at: "<%= @appointment.ends_at %>",
                nurse_id: "<%= @appointment.nurse_id %>",
                patient_id: "<%= @appointment.patient_id %>",
                color: "<%= @appointment.color %>",
                title: "<%= @appointment.title %>",
                description: "<%= @appointment.description %>"
              }
            };
            let appointment_url = '/plannings/' + <%= @appointment.planning_id %> + '/appointments/' + <%= @appointment.id %> + '/toggle_cancelled';
            $.ajax({
              url: appointment_url,
              type: 'PATCH',
              data: appointment_data
            })
          }
        }
      })
    })
  })

<% else %>
  if (typeof pathname === 'undefined') {
    let pathname
  }
  pathname = window.location.pathname;

  $('.modal').modal('hide');
  $('.modal-backdrop').remove();

  if (pathname.includes('payable')) {
    <% if @salary_line_item.present? && @salary_line_item.cancelled && @corporation.detailed_cancellation_options %>
      $('#remote_container').html('<%= j render "salary_line_items/cancellation_options" %>');
      $('#cancellation_options').modal({backdrop: 'static'});
      reloadWhenDismissedInPayable()
    <% else %>
      Turbolinks.reload()
    <% end %>
  } else {
    if (typeof calendar === 'undefined') {
      let calendar;
    }
    if ($('.calendar').length > 0) {
      calendar = $('.calendar');
    } else if ($('.patient_calendar').length > 0) {
      calendar = $('.patient_calendar');
    } else if ($('.nurse_calendar').length > 0) {
      calendar = $('.nurse_calendar');
    } else if ($('.master_calendar').length > 0) {
      calendar = $('.master_calendar');
    }

    calendar.fullCalendar('removeEvents', '<%= "appointment_#{@appointment.id}" %>' );

    calendar.fullCalendar(
      'renderEvent', 
      $.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe  %>"), 
      false
    );

    <% if @salary_line_item.present? && @salary_line_item.cancelled && @corporation.detailed_cancellation_options %>
      $('#remote_container').html('<%= j render "salary_line_items/cancellation_options" %>');
      $('#cancellation_options').modal('show');
      reloadWhenDismissedInPayable()
    <% end %>
  }

<% end %>