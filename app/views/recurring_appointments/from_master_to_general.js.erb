<% if @new_appointment.errors.any? %>
    $('#nurse-conflict-days').text("<%= j @new_appointment.errors[:base].join('、') + 'の従業員が重複してます。' %>")
    $('.modal').modal('hide');
    $('#nurse-conflict-confirm').dialog({
      resizable: false,
      height: 'auto',
      width: 400,
      modal: true,
      buttons: {
        '登録する':function(){
          $(this).dialog('close');
          let appointment_ids = <%=  @new_appointment.errors[:nurse_id].flatten %>;
          let master_to_general =  0;
          console.log(appointment_ids.length)
          appointment_ids.forEach(function(appointment_id){
            let request_edit_url = '/plannings/' + <%= @new_appointment.planning_id %> + '/appointments/' + appointment_id + '/toggle_edit_requested';

            $.ajax({
              url: request_edit_url,
              type: 'PATCH',
              success: function(data) {
                if (master_to_general == 0) {
                  master_to_general = 1 ;
                  console.log('should only happen once')
                  $.ajax({
                      url: "<%= j from_master_to_general_path(@planning, @recurring_appointment) %>",
                      type: 'PATCH'
                  })   
                }
              }
            })
          })
        },
        'キャンセル':function(){
          $(this).dialog('close');
        }
      }
    })
<% else %>
    $('.modal').modal('hide');
    alert("サービスが全体スケジュールへ反映されました")
<% end %>