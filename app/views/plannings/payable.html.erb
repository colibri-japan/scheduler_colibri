<%= render partial: 'plannings/planning_left_menu', locals: {view: 'payable', resource_path: current_user.schedule_default_url_option || planning_nurse_path(@planning, @nurse), resource_master_path: planning_nurse_master_path(@planning, @nurse), nurse: @nurse} %>

<div id="resource-list-container" class="no-print">
  <div id="resource-container" class="scrollbar-custom">
	<div id="nurses-resource" class="no-print">
			<div class="nurses-resource-subsection-title resource-title-selectable"  data-url="<%= planning_payable_path(@planning, params: {m: @selected_month, y: @selected_year}) %>">全員</div>
			<% @grouped_nurses.each do |group, nurses| %>
				<div class="nurses-resource-subsection-title <%= 'resource-title-selectable colibri-clickable-link' if @teams_id_by_name.present? %>" data-url='<%= "/plannings/#{@planning.id}/teams/#{@teams_id_by_name[group]}/payable?m=#{@selected_month}&y=#{@selected_year}" if @teams_id_by_name.present? %>'><%= group %></div>
				<% nurses.each do |nurse| %>
					<p class="resource-list-element colibri-clickable-link" data-url="<%= planning_nurse_payable_path(@planning, nurse, params: {m: @selected_month, y: @selected_year}) %>"><%= nurse.try(:name) %></p>
				<% end %>
			<% end %>
	</div>
  </div>
</div>

<div id="payable-container">
	<% if current_user.corporation_admin? %>
	
		<div class='colibri-xs-title no-print' style='margin-left:5px'>給与統計</div>
		<div class='no-print'>
			<%= select_tag '年', options_for_select([['2018年', 2018],['2019年', 2019], ['2020年', 2020], ['2021年', 2021]], params[:y]), id: 'query_year' %>
			<%= select_tag '月', options_for_select([['1月', 1],['2月', 2], ['3月', 3], ['4月', 4], ['5月',5], ['6月',6], ['7月', 7], ['8月', 8], ['9月', 9], ['10月', 10], ['11月', 11], ['12月', 12]], params[:m]), id: 'query_month' %>
			<button id='payable-query-trigger' class='btn-colibri-light-gray btn btn-sm'><span class="glyphicon glyphicon-refresh" style="color:white;font-size:0.85em"></span></button>
		</div>
		<div class='colibri-dashboard-container-row no-print'>
			<div class='colibri-dashboard-subcontainer'>
				<div class='colibri-subcontainer-header'>
					<span class='colibri-subcontainer-title'>給与推移</span>
				</div>
				<div class='colibri-subcontainer-body'>
					<%= area_chart @provided_services_till_today.group_by_day(:service_date).sum(:total_wage), height: '95%', width: '500px', colors: ['#17a2b8'], suffix: '￥' %>
				</div>
			</div>
			<div class='colibri-dashboard-subcontainer'>
				<div class='colibri-subcontainer-header'>
					<span class='colibri-subcontainer-title'>サービスタイプ割合</span>
				</div>
				<div class='colibri-subcontainer-body'>
					<table class='table'>
						<thead>
							<tr>
								<th>タイプ</th>
								<th>給与計</th>
								<th>稼動時間計</th>
								<th>時間割合</th>
								<th>件数</th>
							</tr>
						</thead>
						<tbody>
							<% @provided_services_grouped_by_category.each do |category_key, category_hash| %>
								<tr>
									<td><%= category_name_by_key(category_key) %></td>
									<td><%= category_hash[:sum_weighted_total_wage].to_i %>￥</td>
									<td><%= from_seconds_to_hours_minutes(category_hash[:sum_weighted_service_duration]) %></td>
									<td><%= ((category_hash[:sum_weighted_service_duration].to_f / @sum_of_provided_service_duration.to_f)*100).round(2) %>%</td>
									<td><%= category_hash[:sum_count] %></td>
								</tr>
							<% end %>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class='colibri-dashboard-container-row'>
			<div class='colibri-dashboard-subcontainer'>
				<div class='colibri-subcontainer-header'>
					<span class='colibri-subcontainer-title'>データをダウンロードする</span>
				</div>
				<div class='colibri-subcontainer-body'>
					<table class='table'>
						<thead>
							<tr>
								<th>レポート名</th>
								<th>アクション</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>従業員別実績</td>
								<td><%= link_to '<i class="glyphicon glyphicon-download" style="color:white;font-size:16px"></i> エクセル'.html_safe, planning_monthly_general_report_path(@planning, format: :xlsx, params: {m: params[:m], y: params[:y]}), class: 'btn btn-success btn-sm text-white' %></td>
							</tr>
							<tr>
								<td>チーム別実績</td>
								<td><div class="btn btn-sm btn-success text-white" id="teams-report"><i class="glyphicon glyphicon-download" style="color:white;font-size:16px"></i> エクセル</div></td>
							</tr>
							<tr>
								<td>新規利用者</td>
								<td><%= link_to '<i class="glyphicon glyphicon-download" style="color:white;font-size:16px"></i> エクセル'.html_safe, planning_recent_patients_report_path(@planning, format: :xlsx), class: 'btn btn-success btn-sm text-white' %></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

		</div>
	
		<div class='colibri-xs-title no-print' style='margin-left:5px;margin-top:20px'>カスタム手当</div>

    <%= link_to '+新規手当', new_salary_rule_path, remote: true, class: 'btn btn-info', style: 'margin-left:5px;margin-top:8px' %>

		<div class='colibri-dashboard-container-row'>
		  <div class='colibri-dashboard-subcontainer' id='colibri-salary-rules-index'>
			</div>
		</div>

	<% end %>
	

	<div id='extended-daily-summary-title-container'>
    <div class='colibri-xs-title'>業務日報</div>
    <div class='small-side-margins'><%= text_field_tag 'query_date', "#{Date.today.strftime("%Y-%m-%d")}", {data: {url: dashboard_extended_daily_summary_path}} %></div>
    <div class='btn btn-sm btn-success text-white small-side-margins no-print' id='print-button'>印刷</div>
  </div>

  <div id='extended-daily-summary-container'>
    <%= render partial: 'extended_daily_summary', locals: {daily_appointments: @daily_appointments, weekly_appointments: @weekly_appointments, monthly_appointments: @monthly_appointments, daily_provided_services: @daily_provided_services, female_patients_ids: @female_patients_ids, male_patients_ids: @male_patients_ids} %>
  </div>
</div>

<div id="team-report-range" class="modal fade" style="display:none">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="colibri-small-title">チームレポート期間を選択する</h1>
				<button type="button" class="close" data-dismiss="modal">&times;</button>
			</div>
			<div class="modal-body">
			 <div class="form-group">
				<%= label_tag :report_range, "対象期間", class: "colibri-form-label-dark" %><span class='required-field'>*</span> 
				<%= text_field_tag :report_range, value=nil, {class: 'form-control'} %>
			 </div>

			 <div class="form-group">
			  <button class="btn btn-block btn-info text-white" id="teams-report-download" data-url="<%= planning_teams_report_path(@planning, format: :xlsx) %>">データをダウンロードする</button>
			 </div>
			</div>
		</div>
	</div>
</div>