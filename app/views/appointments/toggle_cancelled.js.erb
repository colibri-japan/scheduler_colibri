<% if @appointment.errors.any? %>
  $('.modal').modal('hide');
  $('.modal-backdrop').remove();
  alert('キャンセル中にエラーが発生しました。')

<% else %>
  if (typeof pathname === 'undefined') {
    let pathname
  }
  pathname = window.location.pathname;

  $('.modal').modal('hide');
  $('.modal-backdrop').remove();

  if (pathname.includes('payable')) {
    <% if @appointment.cancelled && @corporation.detailed_cancellation_options %>
      $('#remote_container').html('<%= j render "appointments/cancellation_options" %>');
      $('#cancellation_options').modal({backdrop: 'static'});
      reloadWhenDismissedInPayable()
    <% else %>
      Turbolinks.reload()
    <% end %>
  } else {
    if (typeof fullcalendar === 'undefined') {
      let fullcalendar;
    }
    if ($('.calendar').length > 0) {
      fullcalendar = $('.calendar');
    } else if ($('.patient_calendar').length > 0) {
      fullcalendar = $('.patient_calendar');
    } else if ($('.nurse_calendar').length > 0) {
      fullcalendar = $('.nurse_calendar');
    } else if ($('.master_calendar').length > 0) {
      fullcalendar = $('.master_calendar');
    } else {
      fullcalendar = ''
    }

    if (fullcalendar) {
      fullcalendar.fullCalendar('removeEvents', '<%= "appointment_#{@appointment.id}" %>' );

      fullcalendar.fullCalendar(
        'renderEvent', 
        $.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe  %>"), 
        false
      );
    }


    if (window.fullCalendar) {
      let event_to_remove = window.fullCalendar.getEventById('<%= "appointment_#{@appointment.id}" %>')
      console.log(event_to_remove)
      event_to_remove.remove()
      window.fullCalendar.addEvent($.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe %>"))
    }

    <% if @appointment.cancelled? && @corporation.detailed_cancellation_options %>
      $('#remote_container').html('<%= j render "appointments/cancellation_options" %>');
      $('#cancellation_options').modal('show');
      reloadWhenDismissedInPayable()
    <% end %>
  }

<% end %>