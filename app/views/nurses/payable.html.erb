<%= javascript_tag do  %>
	window.nursePayableUrl = "<%= j nurse_payable_path(@nurse) %>";
	window.excelUrl = "<%= j nurse_payable_path(@nurse, format: :xlsx) %>"
<% end %>


<%= render 'layouts/nurses_menu' %>

<div id="payable-container">
	<h2><%= "#{@nurse.name}の給与管理" %></h2>

	<div class="">
		フィルター：
		<%= select_tag('schedule-filter', options_from_collection_for_select(@plannings, 'id', 'title', @planning.id), prompt: "スケジュール") %>
	</div>

	<div class="align-right">
		<% if @provided_services %>
			<div class="excel-download btn btn-success text-white">ダウンロードする</div>
		<% elsif @hash %>
			<%= link_to 'サービスの詳細へ戻る', nurse_payable_path(@nurse), class: 'btn btn-secondary text-white' %>
			<%= link_to 'ダウンロードする', nurse_payable_path(@nurse, grouped: 'true', format: :xlsx), class: 'btn btn-success' %>
		<% end %>
	</div>
	<table class="table">
		<thead>
			<tr>
				<th class="table-important-fields">日付</th>
				<th class="table-important-fields">サービスタイプ</th>
				<th class="table-important-fields">利用者名</th>
				<th class="table-important-fields">提供時間</th>
				<th class="table-important-fields">スタート</th>
				<th class="table-important-fields">終了</th>
				<th class="table-important-fields">時給/単価</th>
				<th class="table-important-fields">回数</th>
				<th class="table-important-fields">計</th>
			</tr>
			
		</thead>

		<tbody>
			<% @provided_services.each do |provided_service| %>
			<tr>
				<td><%= provided_service.created_at.strftime("%-m月%-d日") %></td>
				<td><%= provided_service.payable.try(:title) %></td>
				<td><%= provided_service.patient.try(:name) %> </td>
				<td><%= Time.at(provided_service.service_duration).utc.strftime("%H:%M") %></td>
				<td><%= provided_service.payable.start.strftime("%H:%M") %></td>
				<td><%= provided_service.payable.end.strftime("%H:%M") %></td>
				<td>
					<%= form_for provided_service, url: {action: 'update'}, remote: true do |f| %>
						<%= f.text_field :hourly_wage, data: {service_url: provided_service_path(provided_service)}, class: 'edit-hourly-wage' %>
					<% end %>
				</td>
				<td></td>
				<td id="service-total-<%= provided_service.id %>"><%= provided_service.total_wage %>¥</td>

			</tr>
			<% end %>
			<% if @counter.present? %>
				<tr>
					<td></td>
					<td>移動手当</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td>
						<%= form_for @counter, url: {action: 'update'}, remote: true do |f| %>
							<%= f.text_field :hourly_wage, data: {service_url: provided_service_path(@counter)}, class: 'edit-hourly-wage' %>
						<% end %>
					</td>
					<td>
						<%= form_for @counter, url: {action: 'update'}, remote: true do |f| %>
							<%= f.text_field :service_counts, data: {service_url: provided_service_path(@counter)}, class: 'edit-service-counts' %>
						<% end %>
					</td>
					<td id="service-total-<%= @counter.id %>"><%= @counter.total_wage %>¥</td>
				</tr>
			<% end %>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td id="total-salary-label">合計：</td>
				<td id="total-salary"><%= @total_wage %>¥</td>
			</tr>
		</tbody>
		
	</table>


	<table class="table">
		<thead>
			<tr>
				<th class="table-important-fields">サービスタイプ</th>
				<th class="table-important-fields">提供時間</th>
				<th class="table-important-fields">時給/単価</th>
				<th class="table-important-fields">回数</th>
				<th class="table-important-fields">計</th>
			</tr>
		</thead>
		<tbody class="text-not-bold">
			<% @grouped_services.each do |service| %>
				<tr>
					<th><%= service.title %></th>
					<th><%= Time.at(service.service_duration).utc.strftime("%H:%M") %></th>
					<th><%= service.hourly_wage %></th>
					<th><%= service.service_counts %></th>
					<th><%= service.total_wage %></th>
				</tr>
			<% end %>
			<% if @counter.present? %>
				<tr>
					<td>移動手当</td>
					<td></td>
					<td>
						<%= @counter.hourly_wage %>
					</td>
					<td>
						<%= @counter.service_counts %>
					</td>
					<td class="service-total-<%= @counter.id %>"><%= @counter.total_wage %>¥</td>
				</tr>
			<% end %>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td id="total-salary-label">合計：</td>
				<td id="total-salary"><%= @total_wage %>¥</td>
			</tr>
		</tbody>
	</table>
	
</div>