<%= javascript_tag do  %>
	window.patientPayableUrl = "<%= j planning_patient_payable_path(@planning, @patient) %>";
<% end %>

<%= render partial: 'plannings/planning_left_menu', locals: {view: 'payable', resource_path: planning_patient_path(@planning, @patient), resource_master_path: planning_patient_master_path(@planning, @patient), resource_payable_path: planning_patient_payable_path(@planning, @patient, params: {m: @selected_month, y: @selected_year})} %>
<%= render partial: 'plannings/resources_submenu', locals: {individual_resource: 'true', resource_type: 'patient', view: 'payable'} %>

<div id="payable-container">
	<div id="detail-planning-title">
		<p class="planning-activity-module-title" id="payable-title">
			<%= "#{@patient.name}の実績" %>
			<span id="payable-query">
				<%= select_tag '年', options_for_select([['2018年', 2018],['2019年', 2019], ['2020年', 2020], ['2021年', 2021]], params[:y]), id: 'query_year' %>
				<%= select_tag '月', options_for_select([['1月', 1],['2月', 2], ['3月', 3], ['4月', 4], ['5月',5], ['6月',6], ['7月', 7], ['8月', 8], ['9月', 9], ['10月', 10], ['11月', 11], ['12月', 12]], params[:m]), id: 'query_month' %>
				<button id='payable-query-trigger' class='btn btn-sm btn-colibri-light-gray'><span class="glyphicon glyphicon-refresh" style="color:white;font-size:0.85em"></span></button>
			</span>
		</p>
	</div>

    <% if current_user.corporation_admin? %>
        <div id="patient-dashboard" style='display:flex'>
            <div class="patient-dashboard-panel" style='width:calc(66% - 5px);margin-right:5px'>
                <div class="patient-dashboard-panel-title">
                    <%= @selected_month %>月のまとめ
                </div>
                <div class="patient-dashboard-panel-body">
                    請求額：<%= @total_invoiced_to_patient %>¥<br/>
                    総売り上げ：<%= @total_sales %>¥<br/>
                </div>
            </div>
            <div  class="patient-dashboard-panel" style="width:34%">
                <div class="patient-dashboard-panel-title">
                    <%= @selected_month %>月の書類
                </div>
                <div class="patient-dashboard-panel-body">
                    <table class="table">
                        <tr>
                            <td style='width:60%'>請求書.xlsx</td>
                            <td style='width:40%'><%= link_to '<i class="glyphicon glyphicon-download" style="color:white;font-size:14px"></i> エクセル'.html_safe, planning_patient_payable_path(@planning, @patient, {m: @selected_month, y: @selected_year, format: 'xlsx'}), class: 'btn btn-sm btn-success text-white' %></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    <% end %>

	<div class="colibri-payable-subtitle">請求の詳細</div>

    <table class="table">
        <thead>
            <th>サービス内容</th>
            <th>単位数</th>
            <th>回数</th>
            <th>単位計</th>
            <th>額</th>
        </thead>
        <tbody>
            <% @provided_service_summary.each do |service_summary_hash| %>
                <tr>
                    <td><%= service_summary_hash[:official_title] %></td>
                    <td><%= service_summary_hash[:unit_credits] %></td>
                    <td><%= service_summary_hash[:count] %></td>
                    <td><%= service_summary_hash[:sum_total_credits] %></td>
                    <td></td>
                </tr>
            <% end %>
            <% if @provided_service_summary.count > 0 && @corporation.invoicing_bonus_ratio.present? %>
                <tr>
                    <td><%= corporation_bonus_official_text(@corporation) %></td>
                    <td></td>
                    <td></td>
                    <% @sum_of_credits %>
                    <td><%= @bonus_credits %></td>
                    <td></td>
                </tr>
            <% end %>
            <tr>
                <td colspan="3">訪問介護合計</td>
                <td><%= @total_credits %></td>
                <td><%= @total_invoiced_inside_insurance_scope %>¥</td>
            </tr>
            <tr style='border-top:2px solid #ddd !important'>
                <td colspan="3">区分支給限度額内</td>
                <td><%= @credits_within_max_budget %></td>
                <td><%= @amount_invoiced_within_max_budget %>¥</td>
            </tr>
            <tr>
                <td colspan="4">区分支給限度額内の利用者請求額</td>
                <td><%= @amount_invoiced_to_patient_within_max_budget  %>¥</td>
            </tr>
            <tr>
                <td colspan="3">区分支給限度額を超える単位</td>
                <td><%= @credits_exceeding_max_budget %></td>
                <td><%= @amount_invoiced_exceeding_max_budget %>¥</td>
            </tr>
            <% @provided_service_summary_without_insurance.each do |service_summary_hash| %>
                <tr style="<%= 'border-top:2px solid #ddd !important' if @provided_service_summary_without_insurance.index(service_summary_hash) == 0 %>">
                    <td><%= service_summary_hash[:title] %></td>
                    <td><%= service_summary_hash[:unit_credits] %></td>
                    <td><%= service_summary_hash[:count] %></td>
                    <td></td>
                    <td><%= service_summary_hash[:sum_invoiced_total] %>¥</td>
                </tr>
            <% end %>
            <% @cancelled_but_invoiceable_services.each do |cancelled_provided_service| %>
                <tr style="<%= 'border-top:2px solid #ddd !important' if !@provided_service_summary_without_insurance.present? && @cancelled_but_invoiceable_appointments.index(cancelled_provided_service) == 0 %>">
                    <td><%= "#{cancelled_provided_service.title} (#{cancelled_provided_service.service_date.to_date.strftime('%-m月%-d日')} キャンセル)" %></td>
                    <td></td>
                    <td>1</td>
                    <td></td>
                    <td><%= cancelled_provided_service.invoiced_total %>¥</td>
                </tr>
            <% end %>
            <tr>
                <td colspan="4">保険対象外合計</td>
                <td><%= @total_invoiced_outside_insurance_scope %>¥</td>
            </tr>
            <tr style='border-top:2px solid #ddd !important;font-weight:bold;font-size:1.3em'>
                <td colspan="4">合計</td>
                <td><%= @total_invoiced_to_patient %>¥</td>
            </tr>
        </tbody>
    </table>


	<div class="colibri-payable-subtitle" style='margin-top:50px'>実績詳細</div>

	<table class="table" style='margin-bottom:100px'>
		<thead>
			<tr>
				<th style="width:11%">日付</th>
				<th style="width:13%">タイプ</th>
				<th style="width:11%">従業員</th>
				<th style="width:10%">提供時間</th>
				<th style="width:10%">開始~終了</th>
				<th style="width:18%" colspan="2">確認<span style="font-weight:bold"></span></th>
				<th style="width:8%">編集</th>
			</tr>
		</thead>

		<tbody>
			<% @services_from_appointments.each do |provided_service| %>
                <tr>
                    <td class="<%= weekend_holiday_provided_service_css(provided_service) if provided_service.weekend_holiday_provided_service? %>"><%= provided_service.service_date.strftime("%-m月%-d日") + ' ' + weekday(provided_service.service_date) %></td>
                    <td><%= provided_service_title_with_counts(provided_service) %></td>
                    <td><%= provided_service.nurse.try(:name) %> </td>
                    <td><%= from_seconds_to_hours_minutes(provided_service.service_duration) if provided_service.service_duration.present? %></td>
                    <td><%= "#{provided_service.appointment_start.strftime('%H:%M')}~#{provided_service.appointment_end.strftime('%H:%M')}"  if provided_service.appointment_start.present? && provided_service.appointment_end.present? %></td>
                    <td style="width:9%">
                        <div style="display:flex" id='provided-service-<%= provided_service.id %>'>
                            <div class='<%= 'cancelled-provided-service' if provided_service.cancelled == true %> <%= 'edit-requested-provided-service' if provided_service.appointment.present? && provided_service.appointment.edit_requested == true %>' style="display:flex">
                                <% if provided_service.cancelled == true %>
                                    <span>キャンセル</span>
                                <% elsif provided_service.appointment.present? && provided_service.appointment.edit_requested == true %>
                                    <span>調整中リスト</span>
                                <% else %>
                                    <% if provided_service.verified? %>
                                    <div><span class='glyphicon glyphicon-check'  style="color: #42B97C"></span></div>
                                    <%= link_to "#{provided_service.verifier.try(:name)} #{provided_service.try(:verified_at).strftime('%y/%m/%d')}", toggle_verified_provided_service_path(provided_service), remote: true, method: :patch, class: 'verified-at-and-by', data: {confirm: '実績の確認が解除されます'} %>
                                    <% else %>
                                    <%= link_to '確認１', toggle_verified_provided_service_path(provided_service), method: :patch, remote: :true, class: 'btn btn-success btn-sm' if !provided_service.verified? %>
                                    <% end %>
                                <% end %>
                            </div>
                        </div>
                    </td>
                    <td style='width:9%'>
                        <div style="display:flex" id='provided-service-second-verified-<%= provided_service.id %>'>
                            <div style="display:flex">
                                <% if provided_service.cancelled == true %>
                                    <%= link_to '+手当', provided_service_new_cancellation_fee_path(provided_service), remote: true, class: 'btn btn-sm btn-colibri-light-gray text-white' %>
                                <% elsif provided_service.appointment.present? && provided_service.appointment.edit_requested == true %>
                                <% else %>
                                    <% if provided_service.second_verified? %>
                                    <div><span class='glyphicon glyphicon-check'  style="color: #42B97C"></span></div>
                                    <%= link_to "#{provided_service.second_verifier.try(:name)}#{provided_service.try(:second_verified_at).strftime('%y/%m/%d')}", toggle_second_verified_provided_service_path(provided_service), remote: true, method: :patch, class: 'verified-at-and-by', data: {confirm: '実績の確認が解除されます'} %>
                                    <% else %>
                                    <%= link_to '確認２', toggle_second_verified_provided_service_path(provided_service), method: :patch, remote: :true, class: 'btn btn-success btn-sm' if !provided_service.second_verified? %>
                                    <% end %>
                                <% end %>
                            </div>
                        </div>
                    </td>
                    <td>
                        <%= link_to '編集', edit_planning_appointment_path(@planning, provided_service.appointment), remote: true, class: 'btn btn-sm btn-colibri-light-gray text-white'  if provided_service.appointment.present? %>
                    </td>
                </tr>
			<% end %>
		</tbody>
	</table>
	
</div>