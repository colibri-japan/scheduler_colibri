<% if @appointment.errors.any? %>
  alert("<%= j @appointment.errors.values.join('; ') %>");
<% else %>
  if (typeof pathname === 'undefined') {
    let pathname
  }
  pathname = window.location.pathname;

  if (pathname.includes('payable')) {
    Turbolinks.reload()
  } else {
    $('.modal').modal('hide');

    if (typeof fullcalendar === 'undefined') {
      let fullcalendar;
    }
    if (typeof toggleEditRender === 'undefined') {
      let toggleEditRender;
    }

    if ($('.calendar').length > 0) {
      fullcalendar = $('.calendar');
      toggleEditRender = true;
    } else if ($('.patient_calendar').length > 0) {
      fullcalendar = $('.patient_calendar');
      toggleEditRender = '<%= @appointment.patient_id %>' == window.patientId 
    } else if ($('.nurse_calendar').length > 0) {
      fullcalendar = $('.nurse_calendar');
      toggleEditRender = '<%= @appointment.nurse_id %>' == window.nurseId
    } else if ($('.master_calendar').length > 0) {
      fullcalendar = $('.master_calendar');
      toggleEditRender = '<%= @appointment.patient_id %>' == window.patientId || '<%= @appointment.nurse_id %>' == window.nurseId
    } else {
      fullcalendar = ''
      toggleEditRender = ''
    }    

    if (fullcalendar) {
      calendar.fullCalendar('removeEvents', '<%= "appointment_#{@appointment.id}" %>' );
    }

    if (toggleEditRender) {
      calendar.fullCalendar(
        'renderEvent', 
        $.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe  %>"), 
        false
      );
    }

    if (typeof renderEvent === 'undefined') {
      let renderEvent
    }
  
    renderEvent = (window.currentResourceType === 'team') || (window.currentResourceId === 'all') || (window.currentResourceType && ['<%= "patient_#{@appointment.patient_id}" %>', '<%= "nurse_#{@appointment.nurse_id}" %>'].includes(`${window.currentResourceType}_${window.currentResourceId}`)) || (!window.currentResourceType && (window.defaultResourceType === 'team' || window.defaultResourceId === 'all' || ['<%= "patient_#{@appointment.patient_id}" %>', '<%= "nurse_#{@appointment.nurse_id}" %>'].includes(`${window.defaultResourceType}_${window.defaultResourceId}`)))

    if (window.fullCalendar) {
      let event_to_remove = window.fullCalendar.getEventById('<%= "appointment_#{@appointment.id}" %>')
      event_to_remove.remove()

      if (renderEvent) {
        window.fullCalendar.addEvent($.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe %>"), 'url1')
      }
    }

  }


<% end %>