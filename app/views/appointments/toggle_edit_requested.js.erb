<% if @appointment.errors.any? %>
  alert("<%= j @appointment.errors.values.join('; ') %>");
<% else %>
  if (typeof pathname === 'undefined') {
    let pathname
  }
  pathname = window.location.pathname;

  if (pathname.includes('payable')) {
    Turbolinks.reload()
  } else {
    $('.modal').modal('hide');

    if (typeof fullcalendar === 'undefined') {
      let fullcalendar;
    }
    if (typeof toggleEditRender === 'undefined') {
      let toggleEditRender;
    }

    if ($('.calendar').length > 0) {
      fullcalendar = $('.calendar');
      toggleEditRender = true;
    } else if ($('.patient_calendar').length > 0) {
      fullcalendar = $('.patient_calendar');
      toggleEditRender = '<%= @appointment.patient_id %>' == window.patientId 
    } else if ($('.nurse_calendar').length > 0) {
      fullcalendar = $('.nurse_calendar');
      toggleEditRender = '<%= @appointment.nurse_id %>' == window.nurseId
    } else if ($('.master_calendar').length > 0) {
      fullcalendar = $('.master_calendar');
      toggleEditRender = '<%= @appointment.patient_id %>' == window.patientId || '<%= @appointment.nurse_id %>' == window.nurseId
    } else {
      fullcalendar = ''
      toggleEditRender = ''
    }    

    if (fullcalendar) {
      calendar.fullCalendar('removeEvents', '<%= "appointment_#{@appointment.id}" %>' );
    }

    if (toggleEditRender) {
      calendar.fullCalendar(
        'renderEvent', 
        $.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe  %>"), 
        false
      );
    }

    if (window.fullCalendar) {
      let event_to_remove = window.fullCalendar.getEventById('<%= "appointment_#{@appointment.id}" %>')
      event_to_remove.remove()
      if (window.currentResourceType === 'team' || (window.currentResourceType === 'nurse' && window.currentResourceId === 'all') || (window.currentResourceType === 'patient' || window.currentResourceId === 'all')) {
        window.fullCalendar.addEvent($.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe %>"))
      } else {
        if (['<%= j "patient_#{@appointment.patient_id}" %>', '<%= j "nurse_#{@appointment.nurse_id}" %>'].includes(`${window.currentResourceType}_${window.currentResourceId}`)) {
          window.fullCalendar.addEvent($.parseJSON("<%= j render(partial: 'appointments/appointment.json', locals: {appointment: @appointment}).html_safe %>"))
        } else {
        }
      }
    }

  }


<% end %>