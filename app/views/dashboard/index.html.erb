<div id='dashboard-plannings-container'>
  <div id='new-planning-container'>
    <%= link_to '+新規スケジュール', new_planning_path, class: 'btn btn-info btn-sm text-white btn-margin-top' %>
  </div>
  <div id='dashboard-plannings-list' class="scrollbar-custom  colibri-scrollbar-dark">
    <% @plannings.each do |planning| %>
      <div>
        <%= link_to "#{planning.title}", planning, class: 'planning-list-element' %>
      </div>
    <% end %>
  </div>
</div>

<div id='colibri-dashboard-container'>

  <div class='colibri-dashboard-big-container'>
    <div class='colibri-dashboard-container-column'>

      <div class='colibri-dashboard-subcontainer subcontainer-column-half-height'>
        <div class='colibri-subcontainer-header'>
          <span class='colibri-subcontainer-title'>最新履歴</span><span class="unseen-activity-count"><%= "   ログアウト以降：#{@unseen_activity_count}" %></span>
        </div>
        <div class='colibri-subcontainer-body scrollbar-custom colibri-scrollbar-light' >
          <% @activities.each do |activity| %>
            <%= render partial: 'activities/activity', locals: {activity: activity} %>
          <% end %>
        </div>
      </div>


      <div class='colibri-dashboard-subcontainer subcontainer-column-half-height'>
        <div class='colibri-subcontainer-header'>
          <span class='colibri-subcontainer-title'>調整中リスト（先２週間）</span>
        </div>
        <div class='colibri-subcontainer-body scrollbar-custom colibri-scrollbar-light'>
          <table class='table'>
            <thead>
              <tr>
                <th>サービス</th>
                <th>利用者名</th>
                <th>提供日</th>
                <th>稼働時間</th>
              </tr>
            </thead>
            <tbody>
              <% @edit_requested_appointments.each do |appointment| %>
              <tr>
                <td><%= appointment.title %></td>
                <td><%= appointment.patient.name %></td>
                <td><%= appointment.starts_at.strftime("%-m月%-d日") %></td>
                <td><%= from_seconds_to_hours_minutes(appointment.ends_at - appointment.starts_at) %></td>
              </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>


    </div>

    <div class='colibri-dashboard-container-column'>
      <div class='colibri-dashboard-subcontainer subcontainer-column-full-height'>
        <div class='colibri-subcontainer-header'>
          <span class='colibri-subcontainer-title'>掲示板</span>
        </div>
        <div class='colibri-subcontainer-body-with-footer scrollbar-custom colibri-scrollbar-light' id='posts-container'>
          <% @posts.each do |post| %>
            <%= render partial: 'posts/post', locals: {post: post} %>
          <% end %>
        </div>
        <div class='colibri-subcontainer-footer'>
          <%= link_to '新規メッセージ', new_post_path, remote: true, class: 'btn btn-info text-white form-control btn-block' %>
        </div>
      </div>
    </div>

  </div>


  <div class='colibri-dashboard-container-row'>
    <div class='colibri-dashboard-subcontainer'>
      <div class='colibri-subcontainer-header'>
        <span class='colibri-subcontainer-title'>コメント付きサービス（先２週間）</span>
      </div>
      <div class='colibri-subcontainer-body  scrollbar-custom colibri-scrollbar-light'>
        <table class='table'>
          <thead>
            <tr>
              <th style="width:20%">利用者</th>
              <th style="width:20%">従業員</th>
              <th style="width:20%">開始時間</th>
              <th style="width:40%">コメント</th>
            </tr>
          </thead>
          <tbody>
            <% @commented_appointments.each do |appointment| %>
            <tr>
              <td style="width:15%"><%= "#{appointment.patient.name }様"%></td>
              <td style="width:15%"><%= "#{appointment.nurse.name }"%></td>
              <td style="width:15%"><%= appointment.starts_at.strftime("%-m月%-d日") %></td>
              <td style="width:55%"><%= appointment.description %></td>
            </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
    
  </div>

  <div class='colibri-dashboard-container-row'>
    <div class='colibri-dashboard-subcontainer'>
        <div class='colibri-subcontainer-header'>
          <span class='colibri-subcontainer-title'>利用状況(本日)</span>
        </div>
          <div class='colibri-subcontainer-body  scrollbar-custom colibri-scrollbar-light'>
            <table class='table'>
              <thead>
                <tr>
                  <th class="table-important-fields">サービス</th>
                  <th class="table-important-fields">女</th>
                  <th class="table-important-fields">男</th>
                  <th class="table-important-fields">計</th>
                </tr>
              </thead>
              <tbody>
                <%  @appointments_grouped_by_title.each do |service_name, appointments| %>
                  <tr>
                    <td><%= service_name %></td>
                    <td><%= appointments.select{|appointment| @female_patients_ids.include?(appointment.patient_id)}.count %></td>
                    <td><%= appointments.select{|appointment| @male_patients_ids.include?(appointment.patient_id)}.count %></td>
                    <td><%= appointments.count %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
    </div>

    <div class='colibri-dashboard-subcontainer'>
      <div class='colibri-subcontainer-header'>
        <span>利用状況（今週）</span>
      </div>
      <div class="colibri-subcontainer-body scrollbar-custom colibri-scrollbar-light">
        <table class="table">
          <thead>
            <tr>
              <th class="table-important-fields">サービス</th>
              <th class="table-important-fields">女</th>
              <th class="table-important-fields">男</th>
              <th class="table-important-fields">計</th>
            </tr>
          </thead>
          <tbody>
            <%  @weekly_appointments_grouped_by_title.each do |service_name, appointments| %>
              <tr>
                <td><%= service_name %></td>
                <td><%= appointments.select{|appointment| @female_patients_ids.include?(appointment.patient_id)}.count %></td>
                <td><%= appointments.select{|appointment| @male_patients_ids.include?(appointment.patient_id)}.count %></td>
                <td><%= appointments.count %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class='colibri-dashboard-container-row-large'>

    <div class='colibri-dashboard-subcontainer'>
      <div class='colibri-subcontainer-header'>
        <span class='colibri-subcontainer-title'>本日のサービス</span>
      </div>
        <div class='colibri-subcontainer-body scrollbar-custom colibri-scrollbar-light'>
          <table class='table'>
            <thead>
              <tr>
                <th class="table-important-fields">利用者名</th>
                <th class="table-important-fields">性別</th>
                <th class="table-important-fields">訪問時間</th>
                <th class="table-important-fields">従業員</th>
                <th class="table-important-fields">サービスタイプ</th>
                <th class="table-important-fields">確認する</th>
              </tr>
            </thead>
            <tbody>
              <% @daily_provided_services.each do |nurse_id, provided_service_array| %>
                <% provided_service_array.each do |provided_service| %>
                  <tr>
                    <td><%= provided_service.patient.try(:name) %></td>
                    <td><%= patient_gender(provided_service.patient) %></td>
                    <td><%= "#{provided_service.appointment_start.strftime('%H:%M')} ~ #{provided_service.appointment_end.strftime('%H:%M')}" if provided_service.appointment_end.present? && provided_service.appointment_start.present? %></td>
                    <td><%= provided_service.nurse.try(:name) %></td>
                    <td><%= provided_service.title %></td>
                    <td class='verify-provided-service' id='provided-service-<%= provided_service.id %>'>
                      <% if provided_service.verified? %>
                        <div><span class='glyphicon glyphicon-ok'  style="color: #42B97C"></span></div>
                      <% else %>
                        <%= link_to '確認', verify_provided_service_path(provided_service), method: :patch, remote: :true, class: 'btn btn-success btn-sm' if !provided_service.verified? %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
    </div>
  </div>

</div>
